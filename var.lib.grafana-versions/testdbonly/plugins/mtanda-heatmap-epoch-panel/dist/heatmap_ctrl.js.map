{"version":3,"sources":["../src/heatmap_ctrl.js"],"names":[],"mappings":"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","file":"heatmap_ctrl.js","sourcesContent":["import template from './template';\nimport angular from 'angular';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport _ from 'lodash';\nimport config from 'app/core/config';\nimport TimeSeries from 'app/core/time_series2';\nimport * as fileExport from 'app/core/utils/file_export';\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\n\nexport class HeatmapEpochCtrl extends MetricsPanelCtrl {\n  /** @ngInject */\n  constructor($scope, $injector, $rootScope, annotationsSrv) {\n    super($scope, $injector, annotationsSrv);\n    this.$rootScope = $rootScope;\n\n    var panelDefaults = {\n      // datasource name, null = default datasource\n      datasource: null,\n      // heatmap options\n      heatmapOptions: {\n        type: 'time.heatmap',\n        axes: ['left', 'bottom'],\n        opacity: function(value, max) {\n          return Math.pow((value/max), 0.7);\n        },\n        windowSize: 60,\n        historySize: 120,\n        buckets: 10,\n        bucketRange: [0, 100],\n        ticks: {\n          left: 5,\n          right: 5\n        }\n      },\n      // legend options\n      legend: {\n        show: true, // disable/enable legend\n        values: false, // disable/enable legend values\n        min: false,\n        max: false,\n        current: false,\n        total: false,\n        avg: false\n      },\n      // time overrides\n      timeFrom: null,\n      timeShift: null,\n      // metric queries\n      targets: [{}],\n    };\n\n    _.defaults(this.panel, angular.copy(panelDefaults));\n    _.defaults(this.panel.legend, panelDefaults.legend);\n\n    this.hiddenSeries = {};\n    this.seriesList = [];\n    this.colors = $scope.$root.colors;\n    this.theme = config.bootData.user.lightTheme ? 'epoch-theme-default' : 'epoch-theme-dark';\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Legend', 'public/app/plugins/panel/graph/tab_legend.html', 2);\n    this.addEditorTab('Heatmap Options', 'public/plugins/mtanda-heatmap-epoch-panel/tab_options.html', 3);\n\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  onInitPanelActions(actions) {\n    actions.push({text: 'Export CSV (series as rows)', click: 'ctrl.exportCsv()'});\n    actions.push({text: 'Export CSV (series as columns)', click: 'ctrl.exportCsvColumns()'});\n    actions.push({text: 'Toggle legend', click: 'ctrl.toggleLegend()'});\n  }\n\n  setUnitFormat(axis, subItem) {\n    axis.format = subItem.value;\n    this.render();\n  }\n\n  getEpochLabel(label) {\n    return label.replace(/[ !\"#$%&'()*+,.\\/:;<=>?@\\[\\\\\\]^`{|}~]/g, ' ');\n  }\n\n  issueQueries(datasource) {\n    if (!this.panel.targets || this.panel.targets.length === 0) {\n      return this.$q.when([]);\n    }\n\n    this.panel.targets = _.map(this.panel.targets, function (target) {\n      target.delta = true; // notify delta support\n      return target;\n    });\n\n    return super.issueQueries(datasource);\n  }\n\n  zoomOut(evt) {\n    this.publishAppEvent('zoom-out', evt);\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData.data);\n  }\n\n  onDataError(err) {\n    this.seriesList = [];\n    this.render([]);\n  }\n\n  onDataReceived(dataList) {\n    this.datapointsWarning = false;\n    this.datapointsCount = 0;\n    this.datapointsOutside = false;\n    var maxTimeSeries = 56;\n    if (dataList.length > maxTimeSeries) {\n      var msg = 'heatmap epoch panel warning: exceed max time series (support' + maxTimeSeries + ' time series)';\n      this.$rootScope.appEvent('alert-warning', [msg, '']);\n      dataList = dataList.slice(0, maxTimeSeries); // TODO: support only 5 time series\n    }\n    this.seriesList = dataList.map(this.seriesHandler.bind(this));\n    this.datapointsWarning = this.datapointsCount === 0 || this.datapointsOutside;\n\n    this.loading = false;\n    this.render(this.seriesList);\n  }\n\n  seriesHandler(seriesData, index) {\n    var datapoints = seriesData.datapoints;\n    var alias = seriesData.target;\n    var colorIndex = index % this.colors.length;\n    var color = this.colors[colorIndex];\n\n    var series = new TimeSeries({\n      datapoints: datapoints,\n      alias: alias,\n      color: color,\n      unit: seriesData.delta || false // TODO: fix, use unit as delta temporaly\n    });\n\n    if (datapoints && datapoints.length > 0) {\n      var last = moment.utc(datapoints[datapoints.length - 1][1]);\n      var from = moment.utc(this.range.from);\n      if (last - from < -10000) {\n        this.datapointsOutside = true;\n      }\n\n      this.datapointsCount += datapoints.length;\n    }\n\n    return series;\n  }\n\n  onRender() {\n    if (!this.seriesList) { return; }\n  }\n\n  toggleSeries(serie, event) {\n    if (event.ctrlKey || event.metaKey || event.shiftKey) {\n      if (this.hiddenSeries[serie.alias]) {\n        delete this.hiddenSeries[serie.alias];\n      } else {\n        this.hiddenSeries[serie.alias] = true;\n      }\n    } else {\n      this.toggleSeriesExclusiveMode(serie);\n    }\n    this.render();\n  }\n\n  toggleSeriesExclusiveMode (serie) {\n    var hidden = this.hiddenSeries;\n\n    if (hidden[serie.alias]) {\n      delete hidden[serie.alias];\n    }\n\n    // check if every other series is hidden\n    var alreadyExclusive = _.every(this.seriesList, value => {\n      if (value.alias === serie.alias) {\n        return true;\n      }\n\n      return hidden[value.alias];\n    });\n\n    if (alreadyExclusive) {\n      // remove all hidden series\n      _.each(this.seriesList, value => {\n        delete this.hiddenSeries[value.alias];\n      });\n    } else {\n      // hide all but this serie\n      _.each(this.seriesList, value => {\n        if (value.alias === serie.alias) {\n          return;\n        }\n\n        this.hiddenSeries[value.alias] = true;\n      });\n    }\n  }\n\n  // Called from panel menu\n  toggleLegend() {\n    this.panel.legend.show = !this.panel.legend.show;\n    this.refresh();\n  }\n\n  legendValuesOptionChanged() {\n    var legend = this.panel.legend;\n    legend.values = legend.min || legend.max || legend.avg || legend.current || legend.total;\n    this.render();\n  }\n\n  exportCsv() {\n    fileExport.exportSeriesListToCsv(this.seriesList);\n  }\n\n  exportCsvColumns() {\n    fileExport.exportSeriesListToCsvColumns(this.seriesList);\n  }\n}\n\nHeatmapEpochCtrl.template = template;\n"]}